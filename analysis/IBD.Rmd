---
title: "IBD"
author: "Tina Lasisi"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup}
# Load required packages
library(tidyverse)
library(patchwork)

knitr::opts_knit$set(root.dir = "..")
knitr::opts_chunk$set(eval = TRUE, echo = FALSE, fig.width = 7, fig.height = 6)

```


### Load data and wrangle

```{r}

# Load the data
ibd_data <- read_delim("data/autosomal_ibd_by_pair.20150206.txt", delim = "\t")

# Filter data to only include pairs where both individuals are from the CEU or ASW populations
filtered_data <- ibd_data %>%
  filter((POP1 %in% c('CEU', 'ASW')) & (POP2 %in% c('CEU', 'ASW')))

# Calculate the mean IBD shared within and between the CEU and ASW populations
mean_ibd <- filtered_data %>%
  group_by(POP1, POP2) %>%
  summarise(mean_ibd = mean(IBD_CM_SUM, na.rm = TRUE))

# Print the mean IBD shared within and between the CEU and ASW populations
print(mean_ibd)
```



```{r}
# Visualize the results
ggplot(mean_ibd, aes(x=interaction(POP1, POP2), y=mean_ibd, fill=interaction(POP1, POP2))) +
  geom_bar(stat="identity", position=position_dodge()) +
  labs(x = "Population Pair", y = "Mean IBD (cM)", fill = "Population Pair") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


Here we see that there is much higher mean IBD in the ASW sample than expected. After checking for errors, it appears that this has to do with the nature of the HapMap sample. African Ancestry in SW USA (ASW) contains 20 parent-child duos, 13 trios, and 5 families of 2 or more with only 15 unrelated individuals (see [link](https://catalog.coriell.org/1/NHGRI/Collections/HapMap-Collections/African-Ancestry-in-SW-USA-ASW)). Given the description of the sample, it seems really important to not use this population as a proxy for African Americans. 

Below the filtered data is re-visualized as distributions for different kinship levels. 

```{r}
# Create a population pair variable
filtered_data2 <- filtered_data %>%
  mutate(population_pair = interaction(POP1, POP2))

# Plot the data
ggplot(filtered_data2, aes(x = population_pair, y = IBD_CM_SUM)) +
  geom_violin(trim = FALSE, fill = "#99d8c9", color = "#2ca25f") +
  geom_boxplot(width = 0.1, fill = "#fc9272", color = "#de2d26") +
  labs(x = "Population Pair", y = "Shared IBD (cM)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


```{r}

# Plot the data with a violin plot and box plot
ggplot(filtered_data2, aes(x = population_pair, y = IBD_CM_SUM)) +
  geom_violin(trim = FALSE, fill = "#99d8c9", color = "#2ca25f", width = 0.8) +
  # geom_boxplot(width = 0.05, fill = "#fc9272", color = "#de2d26") +
  geom_jitter(width = 0.1, size = 1, alpha = 0.5) +
  scale_y_continuous(trans = 'log10') +
  geom_hline(aes(yintercept = 3500), color = "red", linetype = "dashed") +
  geom_hline(aes(yintercept = 2625), color = "blue", linetype = "dashed") +
  geom_hline(aes(yintercept = 1750), color = "green", linetype = "dashed") +
  annotate("text", x = 1, y = 3500, label = "Parent-Offspring", hjust = -0.1, vjust= 0.2, color = "red") +
  annotate("text", x = 1, y = 2625, label = "Full-Sibs", hjust = -0.1, vjust= -0.1, color = "blue") +
  annotate("text", x = 1, y = 1750, label = "Half-Sibs/Avuncular", hjust = -0.1, vjust= 0.2, color = "green") +
  labs(x = "Population Pair", y = "Shared IBD (cM, log scale)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

```{r}
# Create a kinship coefficient variable
your_data_frame <- ibd_data %>%
  mutate(kinship_coefficient = IBD_CM_SUM / (4 * 3500))

# Filter the data to include only CEU and ASW populations and calculate relationship categories
filtered_data <- your_data_frame %>%
  filter(POP1 %in% c("CEU", "ASW")) %>%
  mutate(
    relationship = case_when(
      kinship_coefficient < 0.05 ~ "unrelated",
      IBD_CM_SUM > 2000 ~ "first degree relatives",
      TRUE ~ "other relatives"
    )
  )
```


```{r}
# Plot the histograms
ggplot(filtered_data, aes(x = IBD_CM_SUM, fill = POP1)) +
  geom_histogram(alpha = 0.5, position = 'identity', bins = 50) +
  scale_x_log10() +  # Logarithmic scale for x-axis
  facet_grid(rows = vars(relationship), scales = "free") +
  scale_fill_brewer(palette = "Set1") +
  labs(x = "Shared IBD (cM)", y = "Count", fill = "Population") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

```{r}
# Filter only unrelated individuals
unrelated_data <- filtered_data %>%
  filter(relationship == "unrelated")

# Perform t-test
t_test_result <- t.test(IBD_CM_SUM ~ POP1, data = unrelated_data)

# Print the result
print(t_test_result)

```

```{r}
# Create a boxplot
ggplot(unrelated_data, aes(x = POP1, y = IBD_CM_SUM, fill = POP1)) +
  geom_boxplot() +
  scale_y_log10() +  # Logarithmic scale for y-axis
  labs(x = "Population", y = "Shared IBD (cM)", fill = "Population") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```



