---
title: "Estimating Differences in the Distribution of First-degree Relatives"
author: "Manqing Lin, Tina Lasisi"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Introduction

The relative genetic surveillance of a population is influenced by the number of genetically detectable relatives individuals have. First-degree relatives (parents, siblings, and children) are especially relevant in forensic analyses using short tandem repeat (STR) loci, where close familial searches are commonly employed. To explore potential disparities in genetic detectability between African American and European American populations, we examined U.S. Census data from four census years (1960, 1970, 1980, and 1990) focusing on the number of children born to women over the age of 40.

# Data Sources
We used publicly available data from the Integrated Public Use Microdata Series (IPUMS) for the U.S. Census years 1960, 1970, 1980, and 1990. The datasets include information on:

- AGE: Age of the respondent.
- RACE: Self-identified race of the respondent.
- chborn_num: Number of children ever born to the respondent.

Data citation: Steven Ruggles, Sarah Flood, Matthew Sobek, Daniel Backman, Annie Chen, Grace Cooper, Stephanie Richards, Renae Rogers, and Megan Schouweiler. IPUMS USA: Version 14.0 [dataset]. Minneapolis, MN: IPUMS, 2023. https://doi.org/10.18128/D010.V14.0


```{r setup, include=FALSE, echo=TRUE, eval=TRUE}
#knitr::opts_knit$set(root.dir = ".")
knitr::opts_chunk$set(eval = TRUE, echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 7)

# load necessary libraries
library(dplyr)
library(tidyverse)
library(viridis)
library(knitr)
library(scales)
library(rempsyc)
library(patchwork)
library(ggnewscale)
library(gridExtra)
library(purrr)
library(MASS)
library(pscl)
library(ggplot2)
library(nnet)
library(car)
library(rstatix)
library(ggpubr)
```

# Data Preparation
Filtering Criteria: We selected women aged 40 and above to ensure that most had completed childbearing.

Due to the terms of agreement for using this data, we cannot share the full dataset but our repo contains the subset that was used to calculate the mean number of offspring and variance.

Race Classification: We categorized individuals into two groups:

- African American: Those who identified as "Black" or "African American".
- European American: Those who identified as "White".

Calculating Number of Siblings: For each child of these women, the number of siblings (n_sib) is one less than the number of children born to the mother:

$$
n_{sib} = chborn_{num} - 1
$$

```{r}
path <- file.path(".", "data")
savepath <- file.path(".", "output")

prop_race_year <- file.path(path, "proportions_table_by_race_year.csv")
data_filter <- file.path(path, "data_filtered_recoded.csv")

children_data = read.csv(prop_race_year)
mother_data = read.csv(data_filter)
```

```{r, include=FALSE}
df <- mother_data %>%
  # Filter for women aged 40 and above
  filter(AGE >= 40) %>%
  mutate(
    # Create new age ranges
    AGE_RANGE = case_when(
      AGE >= 70 ~ "70+",
      AGE >= 60 ~ "60-69",
      AGE >= 50 ~ "50-59",
      AGE >= 40 ~ "40-49",
      TRUE ~ as.character(AGE_RANGE)  # This shouldn't occur due to the filter, but included for completeness
    ),
    # Convert CHBORN to ordered factor
    CHBORN = factor(case_when(
      chborn_num == 0 ~ "No children",
      chborn_num == 1 ~ "1 child",
      chborn_num == 2 ~ "2 children",
      chborn_num == 3 ~ "3 children",
      chborn_num == 4 ~ "4 children",
      chborn_num == 5 ~ "5 children",
      chborn_num == 6 ~ "6 children",
      chborn_num == 7 ~ "7 children",
      chborn_num == 8 ~ "8 children",
      chborn_num == 9 ~ "9 children",
      chborn_num == 10 ~ "10 children",
      chborn_num == 11 ~ "11 children",
      chborn_num >= 12 ~ "12+ children"
    ), levels = c("No children", "1 child", "2 children", "3 children", 
                  "4 children", "5 children", "6 children", "7 children", 
                  "8 children", "9 children", "10 children", "11 children", 
                  "12+ children"), ordered = TRUE),
    
    # Ensure RACE variable is correctly formatted and filtered
    RACE = factor(RACE, levels = c("White", "Black/African American"))
  ) %>%
  # Filter for African American and European American women
  filter(RACE %in% c("Black/African American", "White")) %>%
  # Select and reorder columns
  dplyr::select(YEAR, SEX, AGE, BIRTHYR, RACE, CHBORN, AGE_RANGE, chborn_num)

# Display the first few rows of the processed data
head(df)

# Summary of the processed data
summary(df)

# Check the levels of the RACE factor
levels(df$RACE)

# Count of observations by RACE
table(df$RACE)

# Count of observations by AGE_RANGE
table(df$AGE_RANGE)
```


# Distribution of Number of Children Across Census Years
First we visualize the general trends in the frequency of the number of children for African American and European American mothers across the Census years by age group. 

```{r}
# Calculate proportions within each group, ensuring proper normalization
df_proportions <- df %>%
  group_by(YEAR, RACE, AGE_RANGE, chborn_num) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(YEAR, RACE, AGE_RANGE) %>%
  mutate(proportion = count / sum(count)) %>%
  ungroup()

# Reshape data for the mirror plot
df_mirror <- df_proportions %>%
  mutate(proportion = if_else(RACE == "White", -proportion, proportion))

# Create color palette
my_colors <- colorRampPalette(c("#FFB000", "#F77A2E", "#DE3A8A", "#7253FF", "#5E8BFF"))(13)

# Create the plot
child_plot <- ggplot(df_mirror, aes(x = chborn_num, y = proportion, fill = as.factor(chborn_num))) +
  geom_col(aes(alpha = RACE)) +
  geom_hline(yintercept = 0, color = "black", size = 0.5) +
  facet_grid(AGE_RANGE ~ YEAR, scales = "free_y") +
  coord_flip() +
  scale_y_continuous(
    labels = function(x) abs(x),
    limits = function(x) c(-max(abs(x)), max(abs(x)))
  ) +
  scale_x_continuous(breaks = 0:12, labels = c(0:11, "12+")) +
  scale_fill_manual(values = my_colors) +
  scale_alpha_manual(values = c("White" = 0.7, "Black/African American" = 1), guide = "none") +
  labs(
    title = "Distribution of Number of Children by Census Year, Race, and Age Range",
    x = "Number of Children",
    y = "Proportion",
    fill = "Number of Children",
    caption = "White population shown on left (negative values), Black/African American on right (positive values)\nProportions normalized within each age range, race, and census year\nFootnote: The category '12+' includes families with 12 or more children."
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, hjust = 0.5),
    axis.text.y = element_text(size = 8),
    strip.text = element_text(size = 10),
    legend.position = "none",
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank()
  )

print(child_plot)
```

```{r, include=FALSE}
# Print summary to check age ranges and normalization
print(df_proportions %>%
  group_by(YEAR, RACE, AGE_RANGE) %>%
  summarise(total_proportion = sum(proportion), .groups = "drop") %>%
  arrange(YEAR, RACE, AGE_RANGE))
```

With this visualization of the distribution of the data, we can see that there are differences between races, census year and age groups. **_NOTE_:**The category '12+' includes families with 12 or more children.

- **_By Census Year:_** From 1960 to 1990, the proportion of mothers with larger families (6+ children) decreases for both races across all age groups.
Smaller families (1-3 children) become more common over the decades.
- **_By Age Group:_** Older age groups (e.g., 70+) show a higher frequency of larger family sizes, especially in earlier Census years. Younger age groups (40-49) show a stronger shift toward smaller family sizes in more recent decades.
- **_By Race:_** African American mothers (right side) consistently show a higher proportion of larger families (6+ children) compared to European American mothers.

```{r, include=FALSE}
# Mean Number of Children By race and Year
df %>% group_by(RACE, YEAR) %>% summarise(Mean = mean(chborn_num))
```


## Model Fit Across Census Years 
We will now find out the best model fitted for each combination of race, census year, and age range. 

### Fit and Compare Models
For each combination, we fit the following candidate models:

- **Poisson Model**
- **Negative Binomial (NB) Model**
- **Zero-Inflated Poisson (ZIP) Model**
- **Zero-Inflated Negative Binomial (ZINB) Model**

```{r, include=FALSE}
combinations <- df %>%
  group_by(YEAR, RACE, AGE_RANGE) %>%
  group_split()

# Initialize the data frame to store results
best_models <- data.frame(
  Race = character(),
  Census_Year = numeric(),
  Age_Range = character(),
  AIC_poisson = numeric(),
  AIC_nb = numeric(),
  AIC_zip = numeric(),
  AIC_zinb = numeric(),
  stringsAsFactors = FALSE
)

# Loop through each subset of data
for (i in seq_along(combinations)) {
  subset_data <- combinations[[i]]
  
  # Fit Poisson model
  poisson_model <- glm(chborn_num ~ 1, family = poisson, data = subset_data)
  # Fit Negative Binomial model
  nb_model <- glm.nb(chborn_num ~ 1, data = subset_data)

  # Fit Zero-Inflated Poisson model
  zip_model <- zeroinfl(chborn_num ~ 1 | 1, data = subset_data, dist = "poisson")

  # Fit Zero-Inflated Negative Binomial model
  zinb_model <- zeroinfl(chborn_num ~ 1 | 1, data = subset_data, dist = "negbin")
  
  # Append the result to the best_models data frame
  best_models <- rbind(
    best_models,
    data.frame(
      Race = unique(subset_data$RACE),
      Census_Year = unique(subset_data$YEAR),
      Age_Range = unique(subset_data$AGE_RANGE),
      AIC_poisson = AIC(poisson_model),
      AIC_nb = AIC(nb_model),
      AIC_zip = AIC(zip_model),
      AIC_zinb = AIC(zinb_model),
      stringsAsFactors = FALSE
    )
  )
}

```


### Record the Best Model for Each Subset
Then, we find the AIC value of four models for each combination and record the model with minimum AIC. The following is the table that summarize the best model for each combination of race, census year and age group.
```{r}
# Add a Best_Model column to store the best model based on minimum AIC
best_models$Best_Model <- apply(best_models, 1, function(row) {
  # Get AIC values for Poisson, NB, ZIP, and ZINB models
  aic_values <- c(Poisson = as.numeric(row['AIC_poisson']),
                  Negative_Binomial = as.numeric(row['AIC_nb']),
                  Zero_Inflated_Poisson = as.numeric(row['AIC_zip']),
                  Zero_Inflated_NB= as.numeric(row['AIC_zinb']))
  
  # Find the name of the model with the minimum AIC value
  best_model <- names(which.min(aic_values))
  
  return(best_model)
})

best_models <- best_models %>% dplyr::select(Race, Census_Year, Age_Range, Best_Model)
# View the updated table with the Best_Model column
kable(best_models, caption="Summary Table of Best Model (Children)")
```


### Analyze the Effect of Race, Census Year, and Age Range
After finding the best model, we want to check if races, age ranges, and census year has significant effect on the best-fitting model. By running a logistics regression, the result (The p-value for each variable is larger than 0.05) shows that there isn't a significant association between the predictors(races, age ranges, and census year) and the best-fitting model.
```{r}
# Recode Best_Model to a binary variable (e.g., "Zero_Inflated_NB" vs. "Other")
best_models$Best_Model_Binary <- ifelse(best_models$Best_Model == "Zero_Inflated_NB", 1, 0)

# Fit binary logistic regression
model_logistic <- glm(Best_Model_Binary ~ Race + Census_Year + Age_Range, family = binomial(), data = best_models)

# Summary of the logistic regression model
summary(model_logistic)

```


### Visualize the Results
According to the resulting visualization, the ZINB model is the best fit for the black population across census year and age group. However, the ZINB model perform the best among the white population only across year 1960 and 1970, and age group 60-69 and 70+.


```{r}
ggplot(best_models, aes(x = Census_Year, y = Age_Range, fill = Best_Model)) +
  geom_tile(color = "white", lwd = 0.5, linetype = 1) + 
  facet_wrap(~Race, nrow = 2) +  
  scale_fill_manual(values = c("Zero_Inflated_Poisson" = "#0072B2", "Zero_Inflated_NB" = "#F0E442")) + 
  labs(
    title = "Best Model by Race, Census Year, and Age Range",
    x = "Census Year",
    y = "Age Range",
    fill = "Best Model"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, hjust = 0.5),
    legend.position = "bottom"
  )
```

 

## Cohort Stability Analysis
From the previous analysis, we observe that there is discrepancy in the distribution between white and black American. Next, the goal is to determine if there is a **significant change** in any of the following across census years for the same cohort:

1. **Zero Inflation**: Check if the proportion of women with zero children changes significantly over time for the same cohort.
2. **Family Size**: Test if the mean and variance in the number of children changes for the same cohort over time.
3. **Model Fit**: Analyze if the best-fitting model for the cohort changes over time.

### Data Preparation
Firstly, we create a new variable cohort in the original data, which is calculated by subtracting the age range from census year.

```{r}
### Table with Cohort
calculate_cohort <- function(census_year, age_range) {
  age_limits <- as.numeric(unlist(strsplit(age_range, "-|\\+")))
  
  if (length(age_limits) == 1) {
    lower_age <- age_limits
    upper_age <- Inf  
  } else {
    lower_age <- age_limits[1]
    upper_age <- age_limits[2]
  }
  
  lower_cohort <- census_year - upper_age
  upper_cohort <- census_year - lower_age
  
  
  if (upper_age == Inf) {
    upper_cohort <- census_year - 70
  }
  
  return(paste(lower_cohort, upper_cohort, sep = "-"))
}

best_models <- best_models %>%
  mutate(Cohort = mapply(calculate_cohort, Census_Year, Age_Range)) %>% 
  dplyr::select(Race, Census_Year, Age_Range, Best_Model, Cohort)

```



```{r}
### Summary Statistics for Each Subset

df_merg <- df %>%
  rename(Census_Year = YEAR, Race = RACE, Age_Range = AGE_RANGE)

# Perform a left join to merge the data frames
merged_data <- left_join(df_merg, best_models, by = c("Race", "Census_Year", "Age_Range"))
```

```{r, include=FALSE}
calculate_mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

summary_table <- merged_data %>% group_by(Race, Cohort, Census_Year) %>%
  summarise(
    Mean = mean(chborn_num),
    Variance = var(chborn_num),
    Mode = calculate_mode(chborn_num),
    Prob_0 = mean(chborn_num == 0),
    Prob_1 = mean(chborn_num == 1),
    Prob_2 = mean(chborn_num == 2),
    Prob_3 = mean(chborn_num == 3),
    Prob_4 = mean(chborn_num == 4),
    Prob_5 = mean(chborn_num == 5),
    Prob_6 = mean(chborn_num == 6),
    Prob_7 = mean(chborn_num == 7),
    Prob_8 = mean(chborn_num == 8),
    Prob_9 = mean(chborn_num == 9),
    Prob_10 = mean(chborn_num == 10),
    Prob_11 = mean(chborn_num == 11),
    Prob_12plus = mean(chborn_num >= 12)
    #Total_Prob = Prob_0 + Prob_1 + Prob_2 + Prob_3 + Prob_4 + Prob_5 + Prob_6 + 
                # Prob_7 + Prob_8 + Prob_9 + Prob_10 + Prob_11 + Prob_12plus
  ) %>%
  ungroup() %>% as.data.frame()
```


### Test for Significant Changes Over Time Within Each Cohort


#### a. **Zero-Inflation Analysis**
Here, we apply the chi-square test for each cohort within each race. Since some cohorts only have one corresponding census year, the test is not applicable for them.
```{r}
## divided the corhort by race
merged_df_black <- merged_data %>% filter(Race == "Black/African American")
merged_df_white <- merged_data %>% filter(Race == "White")
```

```{r, include=FALSE}
# Data frame to store proportions
proportions_df_b <- data.frame(Cohort = character(), Census_Year = character(), 
                             Proportion_Zero_Children = numeric(), Race = character(), stringsAsFactors = FALSE)

# Filter cohorts with more than one census year
cohort_counts <- merged_df_black %>%
  group_by(Cohort) %>%
  summarise(Unique_Census_Years = n_distinct(Census_Year)) %>%
  filter(Unique_Census_Years > 1)

# Get the list of cohorts for testing
cohorts_for_test <- cohort_counts$Cohort

# Initialize results data frame
results_black <- data.frame(RACE = character(), Cohort = character(), Chi_Square = numeric(), p_value = numeric(), stringsAsFactors = FALSE)

# Loop through each cohort and run the chi-square test
for (cohort in cohorts_for_test) {
  cohort_data <- merged_df_black %>% filter(Cohort == cohort)
  
  # Create contingency table
  contingency_table <- table(cohort_data$Census_Year, cohort_data$chborn_num == "0")
  
  # Perform the chi-square test only if more than one row is in the table
  if (nrow(contingency_table) > 1) {
    test_result <- chisq.test(contingency_table)
    
    # Append results to the results data frame
    results_black <- rbind(results_black, data.frame(
      RACE = "Black/African American",
      Cohort = cohort,
      Chi_Square = test_result$statistic,
      p_value = test_result$p.value
    ))
    
    # proportion across year
    proportions <- cohort_data %>%
      group_by(Census_Year) %>%
      summarise(Proportion_Zero_Children = mean(chborn_num == "0"))
    
    proportions$Cohort <- cohort
    proportions$Race <- "Black"
    
    # Combine into one data frame
    proportions_df_b <- rbind(proportions_df_b, proportions)
  
    # Print proportions for review
    print(paste("Proportions for cohort:", cohort))
    print(proportions)
  }
}

results_black <- results_black %>%
  mutate(Significance = ifelse(p_value > 0.05, "No", "Yes"))

print(results_black)

```

```{r}
# Function to determine the nature of change
determine_nature_of_change <- function(proportions) {
  if (nrow(proportions) > 1) {
    if (all(diff(proportions$Proportion_Zero_Children) > 0)) {
      return("Increase")
    } else if (all(diff(proportions$Proportion_Zero_Children) < 0)) {
      return("Decrease")
    } else {
      return("Mixed/No Change")
    }
  } else {
    return("Not Applicable")
  }
}

# Add the Nature_of_Change column
results_black$Nature_of_Change <- NA  # Initialize the column

# Loop through each cohort in results_black
for (i in 1:nrow(results_black)) {
  cohort <- results_black$Cohort[i]
  cohort_data <- merged_df_black %>% filter(Cohort == cohort)
  
  # Calculate proportions for the cohort
  proportions <- cohort_data %>%
    group_by(Census_Year) %>%
    summarise(Proportion_Zero_Children = mean(chborn_num == "0"))
    
  # Determine nature of change
  results_black$Nature_of_Change[i] <- determine_nature_of_change(proportions)
}

results_black$p_value = format(results_black$p_value, scientific = TRUE)

# View the updated results_black
kable(results_black, caption="Test Result of Zero Inflation for Black Population")

```
Above is a table summarize the test result for black population. We observe that the proportion of women with zero children change significantly across census year in the cohort 1901-1910 and 1921-1930.

```{r, include=FALSE}
# Data frame to store proportions
proportions_df_w <- data.frame(Cohort = character(), Census_Year = character(), 
                             Proportion_Zero_Children = numeric(), Race = character(), stringsAsFactors = FALSE)

# Filter cohorts with more than one census year
cohort_counts2 <- merged_df_white %>%
  group_by(Cohort) %>%
  summarise(Unique_Census_Years = n_distinct(Census_Year)) %>%
  filter(Unique_Census_Years > 1)

# Get the list of cohorts for testing
cohorts_for_test2 <- cohort_counts2$Cohort

# Initialize results data frame
results_white <- data.frame(RACE = character(), Cohort = character(), Chi_Square = numeric(), p_value = numeric(), stringsAsFactors = FALSE)

# Loop through each cohort and run the chi-square test
for (cohort in cohorts_for_test2) {
  cohort_data <- merged_df_white %>% filter(Cohort == cohort)
  
  # Create contingency table
  contingency_table <- table(cohort_data$Census_Year, cohort_data$chborn_num == "0")
  
  # Perform the chi-square test only if more than one row is in the table
  if (nrow(contingency_table) > 1) {
    test_result <- chisq.test(contingency_table)
    
    # Append results to the results data frame
    results_white <- rbind(results_white, data.frame(
      RACE = "White",
      Cohort = cohort,
      Chi_Square = test_result$statistic,
      p_value = test_result$p.value
    ))
    
    # proportion across year
    proportions <- cohort_data %>%
      group_by(Census_Year) %>%
      summarise(Proportion_Zero_Children = mean(chborn_num == "0"))
    
    proportions$Cohort <- cohort
    proportions$Race <- "White"
    
    # Combine into one data frame
    proportions_df_w <- rbind(proportions_df_w, proportions)
  
    # Print proportions for review
    print(paste("Proportions for cohort:", cohort))
    print(proportions)
  }
}
results_white <- results_white %>%
  mutate(Significance = ifelse(p_value > 0.05, "No", "Yes"))

print(results_white)
```

```{r}
# Add the Nature_of_Change column
results_white$Nature_of_Change <- NA  # Initialize the column

# Loop through each cohort in results_white
for (i in 1:nrow(results_white)) {
  cohort <- results_white$Cohort[i]
  cohort_data <- merged_df_white %>% filter(Cohort == cohort)
  
  # Calculate proportions for the cohort
  proportions <- cohort_data %>%
    group_by(Census_Year) %>%
    summarise(Proportion_Zero_Children = mean(chborn_num == "0"))
  
  # Determine nature of change
  results_white$Nature_of_Change[i] <- determine_nature_of_change(proportions)
}

results_white$p_value = format(results_white$p_value, scientific = TRUE)

# View the updated results_white
kable(results_white, caption="Test Result of Zero Inflation for White Population")

```
This table summarizes the test result for white population. We observe that the proportion of women with zero children change significantly across census year in cohort 1901-1910, 1911-1920 and 1921-1930.


```{r}
# Combine the two data frames
combined_result <- rbind(results_black, results_white)
```

Combining the results above, we created a plot that demonstrate the change and difference of p value between cohorts and races.

```{r}
# Convert p_value to numeric if necessary
combined_result$p_value <- as.numeric(combined_result$p_value)

# Create the plot
ggplot(combined_result, aes(x = Cohort, y = p_value, color = RACE, shape = Significance)) +
  geom_point(size = 2) +
  geom_line(aes(group = RACE)) +
    annotate("text", x = Inf, y = 0.05, label = "p = 0.05", hjust = 1.1, vjust = -0.5, color = "red", size = 3) +
  geom_hline(yintercept = 0.05, linetype = "dashed", color = "red", size = 0.5) + 
  scale_y_log10() +  # Use log scale for better visualization if p-values vary widely
  labs(
    title = "Change of p-values by Cohort",
    x = "Cohort",
    y = "p-value (log scale)",
    color = "Race",
    shape = "Significance"
  ) +
  theme_minimal() +
  theme(
        plot.title = element_text(size = 14, hjust = 0.5),
axis.text.x = element_text(angle = 45, hjust = 1))

```

The graph shows that there is a discrepancy in the p-value within the cohorts like 1901-1910, 1911-1920 and 1921-1930 by race. However, in cohort 1931-1941, the p-value of each race is pretty close to each other. The overall trend of the p-value for black population is stable across cohort, while the trend for white population fluctuate a lot. 

#### b. **Family Size Analysis (Mean)**
We apply t-test and ANOVA to check if there is a significant difference in the mean family size across the year for the same cohort. In both racial groups, the ANOVA and t-test are not applicable for the following cohort since there is only one census year available in the data for those cohorts:-Inf-1910, 1941-1950, -Inf-1920, -Inf-1890, -Inf-1900, and 1891-1900
```{r}
merged_black = merged_data %>% filter(Race == "Black/African American")
merged_white = merged_data %>% filter(Race == "White")
```

```{r, include=FALSE}
# Initialize an empty data frame for storing results
test_result_b <- data.frame(
  RACE = character(), 
  Cohort = character(), 
  Statistic = numeric(), 
  p_value = numeric(), 
  stringsAsFactors = FALSE
)

cohorts1 <- unique(merged_black$Cohort)

# Loop through each cohort and apply ANOVA or t-test
for (cohort in cohorts1) {
  
  # Filter data for the specific cohort
  cohort_data_b <- merged_black[merged_black$Cohort == cohort, ]
  
  # Check if there are at least two unique Census_Year values
  if (length(unique(cohort_data_b$Census_Year)) < 2) {
    cat("\nCohort:", cohort, "has only 1 Census Year. Skipping ANOVA.\n")
    next
  }
  
  if (length(unique(cohort_data_b$Census_Year)) == 2) {
    # Perform t-test
    t_test_result <- t.test(chborn_num ~ Census_Year, data = cohort_data_b)
    
    # Store results in test_result_b
    test_result_b <- rbind(
      test_result_b, 
      data.frame(
        RACE = "Black/African American",
        Cohort = cohort,
        Statistic = t_test_result$statistic,
        p_value = t_test_result$p.value
      )
    )
    
  } else {
    # Perform ANOVA for Mean
    anova_mean_result <- aov(chborn_num ~ factor(Census_Year), data = cohort_data_b)
    anova_summary <- summary(anova_mean_result)
    
    # Extract F-statistic and p-value from ANOVA result
    f_statistic <- anova_summary[[1]]["factor(Census_Year)", "F value"]
    p_value <- anova_summary[[1]]["factor(Census_Year)", "Pr(>F)"]
    
    # Store results in test_result_b
    test_result_b <- rbind(
      test_result_b, 
      data.frame(
        RACE = "Black/African American",
        Cohort = cohort,
        Statistic = f_statistic,
        p_value = p_value
      )
    )
  }
}

test_result_b <- test_result_b %>%
  mutate(Significance = ifelse(p_value > 0.05, "No", "Yes"))

```

```{r}
test_result_b$p_value = format(test_result_b$p_value, scientific = TRUE)

kable(test_result_b, caption="Test Result of Mean Family Size for Black Population")
```
In the black population, the p-value of cohorts 1901-1910 and 1921-1930 are smaller than 0.05. These results indicate mean family size for these cohort has significantly changed over different census years in different racial population.

```{r, include=FALSE}
# Initialize an empty data frame for storing results
test_result_w <- data.frame(
  RACE = character(), 
  Cohort = character(), 
  Statistic = numeric(), 
  p_value = numeric(), 
  stringsAsFactors = FALSE
)

cohorts2 <- unique(merged_white$Cohort)

# Loop through each cohort and apply ANOVA or t-test
for (cohort in cohorts2) {
  
  # Filter data for the specific cohort
  cohort_data_w <- merged_white[merged_white$Cohort == cohort, ]
  
  # Check if there are at least two unique Census_Year values
  if (length(unique(cohort_data_w$Census_Year)) < 2) {
    cat("\nCohort:", cohort, "has only 1 Census Year. Skipping ANOVA and t-test.\n")
    next
  }
  
  if (length(unique(cohort_data_w$Census_Year)) == 2) {
    # Perform t-test
    t_test_result <- t.test(chborn_num ~ Census_Year, data = cohort_data_w)
    
    # Store results in test_result_w
    test_result_w <- rbind(
      test_result_w, 
      data.frame(
        RACE = "White",
        Cohort = cohort,
        Statistic = t_test_result$statistic,
        p_value = t_test_result$p.value
      )
    )
    
  } else {
    # Perform ANOVA for Mean
    anova_mean_result <- aov(chborn_num ~ factor(Census_Year), data = cohort_data_w)
    anova_summary <- summary(anova_mean_result)
    
    # Extract F-statistic and p-value from ANOVA result
    f_statistic <- anova_summary[[1]]["factor(Census_Year)", "F value"]
    p_value <- anova_summary[[1]]["factor(Census_Year)", "Pr(>F)"]
    
    # Store results in test_result_w
    test_result_w <- rbind(
      test_result_w, 
      data.frame(
        RACE = "White",
        Cohort = cohort,
        Statistic = f_statistic,
        p_value = p_value
      )
    )
  }
}

test_result_w <- test_result_w %>%
  mutate(Significance = ifelse(p_value > 0.05, "No", "Yes"))
```

```{r}
test_result_w$p_value = format(test_result_w$p_value, scientific = TRUE)

kable(test_result_w, caption="Test Result of Mean Family Size for White Population")
```
By looking at the ANOVA and t-test for mean family size in white population, the p-value of cohorts 1901-1910, 1911-1920 and 1921-1930 are smaller than 0.05. 

#### c. **Family Size Analysis (Variance)**
We apply Levene's test to check if there is significant difference in the variance of family size across year for the same cohort. In both racial group, the Levene's test is not applicable for the following cohorts since there is only one census year available in the data for those cohorts:-Inf-1910, 1941-1950, -Inf-1920, -Inf-1890, -Inf-1900, and 1891-1900
```{r, include=FALSE}
# Initialize a results dataframe
test_var_b <- data.frame(
  RACE = character(), 
  Cohort = character(), 
  Statistic = numeric(), 
  p_value = numeric(), 
  stringsAsFactors = FALSE
)

cohorts1 <- unique(merged_black$Cohort)

# Loop through each cohort and apply Levene's Test
for (cohort in cohorts1) {
  
  # Filter data for the specific cohort
  cohort_data_b <- merged_black[merged_black$Cohort == cohort, ]
  
  # Check if there are at least two unique Census_Year values
  if (length(unique(cohort_data_b$Census_Year)) < 2) {
    cat("\nCohort:", cohort, "has only 1 Census Year. Skipping Levene's Test.\n")
    next
  }
  
  # Perform Levene's Test for variance
  levene_result <- leveneTest(chborn_num ~ factor(Census_Year), data = cohort_data_b)
  
  # Extract F-statistic and p-value
  f_statistic <- levene_result[["F value"]][1]
  p_value <- levene_result[["Pr(>F)"]][1]
  
  # Store results in test_var_b
  test_var_b <- rbind(
    test_var_b, 
    data.frame(
      RACE = "Black/African American",
      Cohort = cohort,
      Statistic = f_statistic,
      p_value = p_value
    )
  )
}

# Add significance column
test_var_b <- test_var_b %>%
  mutate(Significance = ifelse(p_value > 0.05, "No", "Yes"))
```

```{r}
kable(test_var_b, caption="Test Result of Variance of Family Size for Black Population")
```
The table above summarizes the test result for black population. We observe that the variance of family size change significantly across census year in cohort 1901-1910 and 1921-1930.

```{r, include=FALSE}
# Initialize a results dataframe
test_var_w <- data.frame(
  RACE = character(), 
  Cohort = character(), 
  Statistic = numeric(), 
  p_value = numeric(), 
  stringsAsFactors = FALSE
)

cohorts1 <- unique(merged_white$Cohort)

# Loop through each cohort and apply Levene's Test
for (cohort in cohorts1) {
  
  # Filter data for the specific cohort
  cohort_data_w <- merged_white[merged_white$Cohort == cohort, ]
  
  # Check if there are at least two unique Census_Year values
  if (length(unique(cohort_data_w$Census_Year)) < 2) {
    cat("\nCohort:", cohort, "has only 1 Census Year. Skipping Levene's Test.\n")
    next
  }
  
  # Perform Levene's Test for variance
  levene_result <- leveneTest(chborn_num ~ factor(Census_Year), data = cohort_data_w)
  
  # Extract F-statistic and p-value
  f_statistic <- levene_result[["F value"]][1]
  p_value <- levene_result[["Pr(>F)"]][1]
  
  # Store results in test_var_w
  test_var_w <- rbind(
    test_var_w, 
    data.frame(
      RACE = "White",
      Cohort = cohort,
      Statistic = f_statistic,
      p_value = p_value
    )
  )
}

# Add significance column
test_var_w <- test_var_w %>%
  mutate(Significance = ifelse(p_value > 0.05, "No", "Yes"))
```

```{r}
kable(test_var_w, caption="Test Result of Variance of Family Size for White Population")
```
This table summarizes the test result for white population. We observe that the variance of family size only change significantly across census year in cohort 1911-1920.

#### d. **Model Fit Analysis**
Due to the due lack of data variability, we use visualization instead of statistical test. Based on the heatmap created, we can see that the model fit for each cohort(cohort with 2+ corresponding census year) across year does not change.


```{r}
# Due to the due lack of data variability, I use visualization instead of test

ggplot(best_models, aes(x = Census_Year, y = Cohort, fill = Best_Model)) +
  geom_tile(color = "white", lwd = 0.5, linetype = 1) + # Create the tiles
  facet_wrap(~Race, nrow = 2) + # Facet by Race
  scale_fill_manual(values = c("Zero_Inflated_Poisson" = "#0072B2", "Zero_Inflated_NB" = "#F0E442")) + 
  labs(
    title = "Best Model by Race, Census Year, and Cohort (Birth Range)",
    x = "Census Year",
    y = "Birth Range",
    fill = "Best Model"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, hjust = 0.5),
    legend.position = "bottom"
  )
```


## Analyzing and Visualizing Significant Fertility Shifts
The goal of this section is to summarize the previous information and create visualization that illustrates significant fertility shifts in cohorts, compares fertility patterns of 40-49 year-olds to 50-59 year-olds in the 1990 census so we can pick the set of fertility distributions we want to use to visualize the sibling distribution and do the math on the genetic surveillance.


### Panel A: Fertility Distribution Shifts Across Cohorts
In this part, we'll summarize the information from the cohort stability and create visualization that illustrates significant fertility shifts in cohorts.  Cohorts that exhibit a significant change over time are represented with solid lines, while those with non-significant changes are depicted using dashed lines.

#### Significant Change in Zero Inflation
```{r}
significant_black <- c("1901-1910", "1921-1930")
significant_white <- c("1901-1910", "1911-1920", "1921-1930")

combined_data <- bind_rows(proportions_df_b, proportions_df_w) %>%
  mutate(Race = factor(Race, levels = c("White", "Black"), 
                       labels = c("White", "Black/African American")))

# Assign line styles
combined_data <- combined_data %>%
  mutate(Line_Style = ifelse((Race == "Black/African American" & Cohort %in%   
                                significant_black) |
                             (Race == "White" & Cohort %in% significant_white),
                             "solid", "dashed"))

# Plot using ggplot2
ggplot(combined_data, aes(x = Census_Year, y = Proportion_Zero_Children, group = Cohort)) +
  geom_line(aes(linetype = Line_Style, color = Cohort), size = 1) +
  geom_point(aes(color = Cohort), size = 2) +
  facet_wrap(~Race) +
  scale_linetype_manual(
    name = "Significance", 
    values = c("solid" = "solid", "dashed" = "dashed"),
    breaks = c("dashed", "solid"),
    labels = c("Non-significant", "Significant")
  ) +
  labs(title = "Significant Changes in Zero Inflation Over Census Years",
       x = "Census Year", y = "Proportion with Zero Children",
       color = "Cohort", linetype = "Significance") +
  theme_minimal() +
  theme(legend.position = "bottom",
        legend.key.size=unit(2,"lines"), 
        plot.title = element_text(size = 14, hjust = 0.5))
```


- In the **black population**, the most significant shifts in childlessness occurred between the 1960 and 1970 census years, where there is a **sharp increase** in the proportion of women with zero children. This trend continues more gradually between 1970 and 1990 but stabilizes for cohort 1921-1930.
- In the **white population**, the increase in childlessness is also visible between 1960 and 1970, but the magnitude of the increase is **more pronounced** compared to African American women. Childlessness stabilizes for cohort 1911-1920 and 1921-1930 between 1970 and 1990, with smaller fluctuations in later decades.

#### Significant Change in Mean Family Size

```{r}
merged_data2 <- left_join(merged_data, summary_table, by = c("Race","Cohort","Census_Year")) %>% dplyr::select(Race, Cohort, Census_Year, Mean, Variance)

combined_data <- unique(merged_data2) %>% filter(Cohort %in% c("1901-1910", "1911-1920", "1921-1930", "1931-1940"))

# Assign line styles
combined_data <- combined_data %>%
  mutate(Line_Style = ifelse((Race == "Black/African American" & Cohort %in% 
                                significant_black) |
                             (Race == "White" & Cohort %in% significant_white),
                              "Significant", "Non-significant"))

ggplot(combined_data, aes(x = Census_Year, y = Mean, group = Cohort)) +
  geom_line(aes(linetype = Line_Style, color = Cohort), size = 1) +
  geom_point(aes(color = Cohort), size = 2) +
  facet_wrap(~Race) +
  scale_linetype_manual(values = c("Significant" = "solid", "Non-significant" = "dashed")) +
  labs(title = "Significant Changes in Mean Family Size Over Census Years",
       x = "Census Year", y = "Mean of number of Children",
       color = "Cohort", linetype = "Significance") +
  theme_minimal() +
  theme(legend.position = "bottom",
        legend.key.size=unit(2,"lines"), 
        plot.title = element_text(size = 14, hjust = 0.5))

```
- For **black population**, the mean family size for the 1921-1930 cohort **increased** substantially in 1990, reaching over 3.6 children on average. However, both cohorts exhibited little change in mean family size in earlier census year (between 1960 and 1980).
- For **white population**, a consistent decline in mean family size was observed for the 1901-1910 and 1911-1920 cohorts from 1960 to 1970. The 1921-1930 cohort showed a modest increase in mean family size in 1990, reaching around 2.8 children on average, which is **smaller than** the black population.

#### Significant Change in Variance of Family Size
```{r}
significant_black <- c("1901-1910", "1921-1930")
significant_white <- c("1911-1920")

combined_data <- unique(merged_data2) %>% filter(Cohort %in% c("1901-1910", "1911-1920", "1921-1930", "1931-1940"))

# Assign line styles
combined_data <- combined_data %>%
  mutate(Line_Style = ifelse((Race == "Black/African American" & Cohort %in% 
                                significant_black) |
                             (Race == "White" & Cohort %in% significant_white),
                              "Significant", "Non-significant"))


ggplot(combined_data, aes(x = Census_Year, y = Variance, group = Cohort)) +
  geom_line(aes(linetype = Line_Style, color = Cohort), size = 1) +
  geom_point(aes(color = Cohort), size = 2) +
  facet_wrap(~Race) +
  scale_linetype_manual(values = c("Significant" = "solid", "Non-significant" = "dashed")) +
  labs(title = "Significant Changes in Variance of Family Size Over Census Years",
       x = "Census Year", y = "Variance of number of Children",
       color = "Cohort", linetype = "Significance") +
  theme_minimal() +
  theme(legend.position = "bottom",
        legend.key.size=unit(2,"lines"), 
        plot.title = element_text(size = 14, hjust = 0.5))

```
- For **black population**, significant decrease in variance occur between 1960 and 1970, particularly for the cohort 1901-1910. Variance continues to shift for cohort 1921-1930 between 1970 and 1990 with the steeper increases.
- For **white population**, there is little change in variance over time. Variance appears to remain stable across Census years for cohort 1911-1920. This stability suggests **less variability** in fertility patterns among women in white population compared to black population.


### Panel B: Comparison of 40-49 and 50-59 Age Groups in 1990
This analysis examines differences in fertility patterns between the 40-49 and 50-59 age groups in 1990, focusing on the distribution, mean number of children, variance, and childlessness (zero inflation) within Black and White populations.

#### Visulization of Distribution
Firstly, we present a side-by-side distribution plots comparing the number of children for women in the 40-49 and 50-59 age groups within Black and White populations.

```{r}
filter_df <- df_proportions %>% 
  filter(YEAR == "1990", AGE_RANGE %in% c("40-49", "50-59")) 
```


```{r}
ggplot(filter_df, aes(x = chborn_num, y = proportion, fill = AGE_RANGE)) +
  geom_col(position = "identity", alpha = 0.5) +  
  facet_wrap(~ RACE) +  
  labs(
    title = "Distribution of Number of Children for Women in 40-49 and 50-59 Age Groups in 1990",
    x = "Number of Children",
    y = "Proportion",
    fill = "Age Range"
  ) +
  theme(
    plot.title = element_text(size = 14, hjust = 0.5))
```
For both racial groups, the 40-49 age group has a distribution more skewed towards 0-2 children. Meanwhile, women in the 50-59 age group generally have larger family sizes compared to the 40-49 age group.

####  Summary Statistics Table
By summarizing the key statistics for each age group and race, we can derive the same insight, which shows that women in the older age group have larger family sizes. On average, women in the 50-59 age group have more children than those in the 40-49 age group. In addition, the variance in the number of children is larger for the 50-59 age group in both racial groups, indicating greater variability in family size. In terms of zero inflation (proportion of women with no children), the women in 40-49 age group have higher zero inflation than women in 50-59 in both racial groups. 

```{r}
summary_stats <- filter_df %>%
  group_by(AGE_RANGE, RACE) %>%
  summarise(
    mean_children = weighted.mean(chborn_num, count),  # Mean number of children
    variance_children = sum(count * (chborn_num - weighted.mean(chborn_num, count))^2) / sum(count),  # Variance
    zero_inflation = sum(count[chborn_num == 0]) / sum(count), .groups = "drop"
  )

# Print summary statistics table
kable(summary_stats, caption= "Summary Statistics of Number of Children in 1990 (40-49 and 50-59 Age Group)")
```

#### Test for Difference in Means
We firstly plot the diagnostic plot to see if the data fulfill the normality assumption. Thought the data for black population and white population violate normality assumption, we can still perform t test to see if there is significant difference in mean for both racial groups in the following due to large sample size (by central limit theorem).

- **Null Hypothesis (H₀):** There is no difference in the mean number of children between the two age groups.
- **Alternative Hypothesis (H₁):** There is a difference in the mean number of children between the two age groups.

```{r, include=FALSE}
## Check the normality assumption for black population
# Subset data for the 40-49 and 50-59 age groups
data_40_49_b <- df %>% filter(AGE_RANGE == "40-49", RACE == "Black/African American", YEAR == "1990")
data_50_59_b <- df %>% filter(AGE_RANGE == "50-59", RACE == "Black/African American", YEAR == "1990")

qqnorm(data_40_49_b$chborn_num, main = "QQ Plot: 40-49 Age Group (Black/African American)")
qqline(data_40_49_b$chborn_num)

# QQ plot for the 50-59 age group
qqnorm(data_50_59_b$chborn_num, main = "QQ Plot: 50-59 Age Group (Black/African American)")
qqline(data_50_59_b$chborn_num)
```


```{r, include=FALSE}
## Check the normality assumption for white population
data_40_49_w <- df %>% filter(AGE_RANGE == "40-49", RACE == "White", YEAR == "1990")
data_50_59_w <- df %>% filter(AGE_RANGE == "50-59", RACE == "White", YEAR == "1990")

qqnorm(data_40_49_w$chborn_num, main = "QQ Plot: 40-49 Age Group (White)")
qqline(data_40_49_w$chborn_num)

# QQ plot for the 50-59 age group
qqnorm(data_50_59_w$chborn_num, main = "QQ Plot: 50-59 Age Group (White)")
qqline(data_50_59_w$chborn_num)
```


```{r}
df_w <- df %>% filter(RACE == "White"& AGE_RANGE %in% c("40-49", "50-59") & YEAR == "1990")
df_b <- df %>% filter(RACE == "Black/African American" & AGE_RANGE %in% c("40-49", "50-59") & YEAR == "1990")

t_test_b <- t.test(chborn_num ~ AGE_RANGE, data = df_b)$p.value
t_test_w <- t.test(chborn_num ~ AGE_RANGE, data = df_w)$p.value

res_df <- data.frame(
  race = c("African American", "European American"),
  p_value = c(t_test_b, t_test_w)
)
res_df$p_value <- format(res_df$p_value, scientific = TRUE)

kable(res_df, caption="Test Result for Difference in Variance between Age Groups By Race")
```
The p-values are both extremely small, meaning there is a very strong statistical difference between the two age groups (40-49 and 50-59) in terms of the mean number of children within each racial group.

#### Test for Difference in Variances
We apply Levene's test since non-normality in data. 

- **Null Hypothesis (H₀):** There is no difference in the variance of the number of children between the two age groups.
- **Alternative Hypothesis (H₁):** There is a difference in the variance of the number of children between the two age groups.

```{r}
## Apply Levene's test since non-normality
# Levene's test for Black group
levene_test_b <- leveneTest(chborn_num ~ as.factor(AGE_RANGE), data = df_b)

# Levene's test for White group
levene_test_w <- leveneTest(chborn_num ~ as.factor(AGE_RANGE), data = df_w)

res_df2 <- data.frame(
  race = c("African American", "European American"),
  p_value = format(c(levene_test_b[["Pr(>F)"]][1], levene_test_w[["Pr(>F)"]][1]), scientific = TRUE)
)

kable(res_df2, caption="Test Result for Difference in Variance between Age Groups By Race")
```
Since the p values are smaller than 0.05 for both racial group, we have enough evidence to reject the null hypothesis, indicating that the variances of the number of children between the two age groups within each racial group are significantly different.

#### Test for Difference in Zero Inflation
To test the difference in zero inflation between age group, we firstly create a contingency tables showing the counts of women with zero children and those with one or more children for each age group. Then we apply chi-square test within each race. 

- **Null Hypothesis (H₀):** There is no difference in the proportion of childlessness between the two age groups.
- **Alternative Hypothesis (H₁):** There is a difference in the proportion of childlessness between the two age groups.

```{r}
# contingency tables showing the counts of women with zero children and those with one or more children for each age group 
ZI_table <- df %>% filter(YEAR == "1990", AGE_RANGE %in% c("40-49", "50-59")) %>% 
  mutate(childlessness = ifelse(chborn_num == 0, "0 Children", "1+ Children")) %>%       group_by(RACE, AGE_RANGE, childlessness) %>%
  summarise(count = n(), .groups = "drop")

kable(ZI_table, caption="Contingency Table of Zero Inflation")
```

```{r}
ZI_table_b <- ZI_table %>%
  filter(RACE == "Black/African American")

cont_table_b <- xtabs(count ~ AGE_RANGE + childlessness, data = ZI_table_b)
chi_test_b <- chisq.test(cont_table_b)
```

```{r}
ZI_table_w <- ZI_table %>%
  filter(RACE == "White")

cont_table_w <- xtabs(count ~ AGE_RANGE + childlessness, data = ZI_table_w)
chi_test_w <- chisq.test(cont_table_w)
```

```{r}
res_df3 <- data.frame(
  race = c("African American", "European American"),
  p_value = format(c(chi_test_b$p.value, chi_test_w$p.value), scientific = TRUE))

kable(res_df3, caption="Test Result for Zero Inflation between Age Groups By Race")
```
The p-values for both tests are extremely low, suggests that there is a significant difference in the proportion of women with 0 children across age ranges (40-49 vs. 50-59) for both the Black/African American and White racial groups. The results imply that childlessness is not uniformly distributed across age groups. 

#### Conclusion
The results of this panel provide clear evidence of significant differences in fertility patterns between the 40-49 and 50-59 age groups for both Black and White populations:

 - **Mean Number of Children:** Women in the 50-59 age group have significantly **more children** on average than those in the 40-49 age group (difference: 1.03 for Black women and 0.69 for White women).
 - **Variance:** The 50-59 age group exhibits **greater variability** in family sizes.
 - **Zero Inflation:** The 40-49 age group has a **higher proportion** of childlessness.
 
These findings highlight generational differences in fertility patterns, with older age groups (50-59) reflecting larger family sizes and greater variability.

#### Implication
These findings suggest notable shifts in fertility trends and behaviors across generations:
  - The 50-59 age group likely represents completed fertility patterns, where women have finished childbearing. This explains the higher mean number of children and greater variance observed in this group.
  - The 40-49 age group, on the other hand, may still include women who have not yet completed their fertility, leading to a higher proportion of childlessness and a distribution skewed towards smaller family sizes.
  - These trends may reflect broader social, economic, and cultural influences on family size, such as changes in education, workforce participation, and access to family planning resources across generations.



# Distribution of Number of Siblings Across Census Years
Having analyzed the distribution of the number of children, we now turn our attention to the distribution of the number of siblings. We will explore the trends in the frequency of the number of siblings for African American and European American mothers across the Census years by age group.

Frequency of siblings is calculated as follows.

$$
\text{freq}_{n_{\text{sib}}} = \text{freq}_{\text{mother}} \cdot \text{chborn}_{\text{num}}
$$

For example, suppose 10 mothers (generation 0) have 7 children, then there will be 70 children (generation 1) in total who each have 6 siblings.

We take our original data and calculate the frequency of siblings for each mother based on the number of children they have. We then aggregate this data to get the frequency of siblings for each generation along with details on the birth years of the relevant children to visualize the distribution of the number of siblings across generations.

## Data Preparation
Firstly, we calculate the number of sibling by subtracting 1 from number of children. Then, we group the data to calculate sibling frequencies and check the normalization by calculating the proportion of sibling frequencies in each combination of census year, race and age range.

```{r}
df2 <- df %>% 
  dplyr::select(RACE, YEAR, AGE_RANGE, chborn_num)
```

```{r}
df2 <- df2 %>%
 mutate(n_siblings = chborn_num - 1)
```

```{r}
### Calculate Sibling Frequencies

df2 <- df2 %>%
mutate(sibling_freq = ifelse(chborn_num != 1, n_siblings * 1, 1))  # Assuming each mother represents 1 in frequency
```

```{r}
### Aggregate Sibling Data
# Group the data and calculate sibling frequencies
df_siblings <- df2 %>%
 group_by(YEAR, RACE, AGE_RANGE, n_siblings) %>%
 summarise(
   sibling_count = sum(sibling_freq),
   .groups = "drop"
 )
```

```{r}
# Calculate proportions within each group
df_sibling_proportions <- df_siblings %>%
 group_by(YEAR, RACE, AGE_RANGE) %>%
 mutate(proportion = sibling_count / sum(sibling_count)) %>%
 ungroup()
```

```{r}
### Check Normalization
normalization_check <- df_sibling_proportions %>%
  group_by(YEAR, RACE, AGE_RANGE) %>%
  summarise(total_proportion = sum(proportion), .groups = "drop") %>%
  arrange(YEAR, RACE, AGE_RANGE)
```


## Visualization of Distribution of Number of Siblings
Then we visualize the general trends in the frequency of the number of siblings for African American and European American mothers across the Census years by age group.
```{r}
df_sibling_mirror <- df_sibling_proportions %>%
  mutate(proportion = if_else(RACE == "White", -proportion, proportion))
```


```{r}
my_colors <- colorRampPalette(c("#FFB000", "#F77A2E", "#DE3A8A", "#7253FF", "#5E8BFF"))(13)
```

```{r}
ggplot(data = df_sibling_mirror %>% filter(n_siblings != "-1"), aes(x = n_siblings, y = proportion, fill = as.factor(n_siblings))) +
 geom_col(aes(alpha = RACE)) +
 geom_hline(yintercept = 0, color = "black", size = 0.5) +
 facet_grid(AGE_RANGE ~ YEAR, scales = "free_y") +
 coord_flip() +
 scale_y_continuous(
   labels = function(x) abs(x),
   limits = function(x) c(-max(abs(x)), max(abs(x)))
 ) +
 scale_x_continuous(breaks = 0:11, labels = c(0:10, "11+")) +
 scale_fill_manual(values = my_colors) +
 scale_alpha_manual(values = c("White" = 0.7, "Black/African American" = 1)) +
 labs(
   title = "Distribution of Number of Siblings by Census Year, Race, and Age Range",
   x = "Number of Siblings",
   y = "Proportion",
   fill = "Number of Siblings",
   caption = "White population shown on left (negative values), Black/African American on right (positive values)\nProportions normalized within each age range, race, and census year\nFootnote: The category '11+' includes individuals with 11 or more siblings."
 ) +
 theme_minimal() +
 theme(
   plot.title = element_text(size = 14, hjust = 0.5),
   axis.text.y = element_text(size = 8),
   strip.text = element_text(size = 10),
   legend.position = "none",
   panel.grid.major.y = element_blank(),
   panel.grid.minor.y = element_blank()
 )
```


```{r, include=FALSE}
# Mean Number of Sibling By race only
df2 %>% filter(RACE == "Black/African American" & n_siblings >= 0) %>% summarise(Mean = mean(n_siblings))

df2 %>% filter(RACE == "White" & n_siblings >= 0) %>% summarise(Mean = mean(n_siblings))
```
With this visualization of the distribution of the data, we can see that there are differences between races, census year and age groups. **_Note:_** The category '11+' includes individuals with 11 or more siblings.

- **_By Census Year:_** 
  - In 1960 and 1970, individuals are more likely to have higher number of siblings,      especially in the 5-10 range. This trend diminishes over time.
  - By 1980 and 1990, the distribution shifts toward smaller family sizes, with a growing proportion of individuals having fewer siblings.

- **_By Age Range:_**
  - 40-49 Age Group: For this group, the number of individuals with 0-2 siblings increases across census years, especially in 1980 and 1990, while the proportion of individuals with larger sibling counts decreases.
  - 50-59 and 60-69 Age Groups: These groups show a similar shift toward smaller family sizes, but the trend is slightly more gradual compared to the younger age group.
  - 70+ Age Group: The shift to fewer siblings is noticeable, although the trend is less pronounced. The distribution remains relatively stable across the census years, with a significant portion of individuals still coming from large families in 1960 and 1970.

- **_By Race:_ **Black/African American Populations (right side of each pair) consistently show a higher proportion of individuals with larger sibling counts (5-10 siblings) compared to White populations. However, similar to the White population, the number of individuals with fewer siblings increases over time.

Comparing the sibling distribution with the children distribution, we find that although both distributions show a trend toward smaller families, the sibling distribution is more spread out across different sibling counts, suggesting potential difference in the distribution. 


## Model Fit Across Census Years

We repeat the model fitting process we performed for the children distribution, this time using the sibling distribution data.

```{r}
combinations2 <- df2 %>%
  # treat number of sib = -1 as NA
  filter(n_siblings != -1) %>%
  group_by(YEAR, RACE, AGE_RANGE) %>%
  group_split()

# Initialize the data frame to store results
best_models_sib <- data.frame(
  Race = character(),
  Census_Year = numeric(),
  AGE_RANGE = character(),
  AIC_poisson = numeric(),
  AIC_nb = numeric(),
  AIC_zip = numeric(),
  AIC_zinb = numeric(),
  stringsAsFactors = FALSE
)

# Loop through each subset of data
for (i in seq_along(combinations2)) {
  subset_data <- combinations2[[i]]
  
  # Fit Poisson model
  poisson_model <- glm(n_siblings ~ 1, family = poisson, data = subset_data)
  # Fit Negative Binomial model
  nb_model <- glm.nb(n_siblings ~ 1, data = subset_data)

  # Fit Zero-Inflated Poisson model
  zip_model <- zeroinfl(n_siblings ~ 1 | 1, data = subset_data, dist = "poisson",control = zeroinfl.control(maxit = 100))
  
  # Fit Zero-Inflated Negative Binomial model with increased max iterations
  zinb_model <- zeroinfl(n_siblings ~ 1 | 1, data = subset_data, dist = "negbin",control = zeroinfl.control(maxit = 100))
  
  # Append the result to the best_models data frame
  best_models_sib <- rbind(
    best_models_sib,
    data.frame(
      Race = unique(subset_data$RACE),
      Census_Year = unique(subset_data$YEAR),
      AGE_RANGE = unique(subset_data$AGE_RANGE),
      AIC_poisson = AIC(poisson_model),
      AIC_nb = AIC(nb_model),
      AIC_zip = AIC(zip_model),
      AIC_zinb = AIC(zinb_model),
      stringsAsFactors = FALSE
    )
  )
}

```


### Fit and Compare Models
For each combination, we again fit the following candidate models:

- **Poisson Model**
- **Negative Binomial (NB) Model**
- **Zero-Inflated Poisson (ZIP) Model**
- **Zero-Inflated Negative Binomial (ZINB) Model**

```{r, include=FALSE}
# Add a Best_Model column to store the best model based on minimum AIC
best_models_sib$Best_Model <- apply(best_models_sib, 1, function(row) {
  # Get AIC values for Poisson, NB, ZIP, and ZINB models
  aic_values <- c(Poisson = as.numeric(row['AIC_poisson']),
                  Negative_Binomial = as.numeric(row['AIC_nb']),
                  Zero_Inflated_Poisson = as.numeric(row['AIC_zip']),
                  Zero_Inflated_NB= as.numeric(row['AIC_zinb']))
  
  # Find the name of the model with the minimum AIC value
  best_models_sib <- names(which.min(aic_values))
  
  return(best_models_sib)
})

best_models_sib <- best_models_sib %>% dplyr::select(Race, Census_Year, AGE_RANGE, Best_Model)
# View the updated table with the Best_Model column
print(best_models_sib)
```

### Record the Best Model for Each Subset
Then, we find the AIC value of four models for each combination and record the model with minimum AIC. The following is the table that summarize the best model for each combination of race, census year and age group.
```{r}
kable(best_models_sib, caption="Summary Table of Best Model (Siblings)")
```

### Visualize the Results
By comparing the pattern of best-fitting models between the sibling and children distributions, we observe that the best model for black population has the same best model(zero-inlfated NB) across year and age range except on one subset(age 40-49 in 1990) in siblings distribution. However, there is a large difference in best model for white population. A large portion of best model in children distribution for white population is zero-inlfated NB, while negative-binomial is the best model fitted for siblings distribution except for one subset(age 40-49 in 1990). 


```{r}
ggplot(best_models_sib, aes(x = Census_Year, y = AGE_RANGE, fill = Best_Model)) +
  geom_tile(color = "white", lwd = 0.5, linetype = 1) + # Create the tiles
  facet_wrap(~Race, nrow = 2) + # Facet by Race
  scale_fill_manual(values = c("Poisson" = "#0072B2", "Zero_Inflated_NB" = "#F0E442", "Negative_Binomial" = "grey")) + 
  labs(
    title = "Best Model(siblings) by Race, Census Year, and Birth Range",
    x = "Census Year",
    y = "Age Range",
    fill = "Best Model"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(size = 14, hjust = 0.5),
    legend.position = "bottom"
  )
```

## Cohort Stability Analysis Siblings

Next, we analyze the stability of sibling distributions across year for each cohorts, similar to the analysis performed for children.

1. **Zero Inflation**: Check if the proportion of individuals with zero siblings changes significantly over time for the same cohort
2. **Family Size**: Test if the mean in the number of siblings changes for the same cohort over time.
3. **Model Fit**: Analyze if the best-fitting model for the cohort changes over time.

#### a. **Zero-Inflation Analysis**
We apply the chi-square test for each cohort within each race. Since some cohorts only have one corresponding census year, the test is not applicable for them.
```{r}
best_models_sib <- best_models_sib %>%
  mutate(Cohort = mapply(calculate_cohort, Census_Year, AGE_RANGE)) %>% 
  dplyr::select(Race, Census_Year, AGE_RANGE, Best_Model, Cohort)

df_merg2 <- df2 %>%
  rename(Census_Year = YEAR, Race = RACE)

# Perform a left join to merge the data frames
merged_data_sib <- left_join(df_merg2, best_models_sib, by = c("Race", "Census_Year", "AGE_RANGE"))
```

```{r}
## divided the corhort by race
merged_df_black2 <- merged_data_sib %>% filter(Race == "Black/African American")
merged_df_white2 <- merged_data_sib %>% filter(Race == "White")
```

```{r}
# Filter cohorts with more than one census year
cohort_counts <- merged_df_black2 %>%
  group_by(Cohort) %>%
  summarise(Unique_Census_Years = n_distinct(Census_Year)) %>%
  filter(Unique_Census_Years > 1)

# Get the list of cohorts for testing
cohorts_for_test <- cohort_counts$Cohort

# Initialize results data frame
results_black2 <- data.frame(RACE = character(), Cohort = character(), Chi_Square = numeric(), p_value = numeric(), stringsAsFactors = FALSE)

# Loop through each cohort and run the chi-square test
for (cohort in cohorts_for_test) {
  cohort_data <- merged_df_black2 %>% filter(Cohort == cohort)
  
  # Create contingency table
  contingency_table <- table(cohort_data$Census_Year, cohort_data$n_siblings == "0")
  
  # Perform the chi-square test only if more than one row is in the table
  if (nrow(contingency_table) > 1) {
    test_result <- chisq.test(contingency_table)
    
    # Append results to the results data frame
    results_black2 <- rbind(results_black2, data.frame(
      RACE = "Black/African American",
      Cohort = cohort,
      Chi_Square = test_result$statistic,
      p_value = test_result$p.value
    ))
  }
}

results_black2 <- results_black2 %>%
  mutate(Significance = ifelse(p_value > 0.05, "No", "Yes"))

kable(results_black2, caption="Test Result of Zero Inflation for Black Population")
```
The table shows that only the cohort 1921-1930 has significant change in probability of individuals with zero siblings in black population.

```{r}
# Filter cohorts with more than one census year
cohort_counts <- merged_df_white2 %>%
  group_by(Cohort) %>%
  summarise(Unique_Census_Years = n_distinct(Census_Year)) %>%
  filter(Unique_Census_Years > 1)

# Get the list of cohorts for testing
cohorts_for_test <- cohort_counts$Cohort

# Initialize results data frame
results_white2 <- data.frame(RACE = character(), Cohort = character(), Chi_Square = numeric(), p_value = numeric(), stringsAsFactors = FALSE)

# Loop through each cohort and run the chi-square test
for (cohort in cohorts_for_test) {
  cohort_data <- merged_df_white2 %>% filter(Cohort == cohort)
  
  # Create contingency table
  contingency_table <- table(cohort_data$Census_Year, cohort_data$n_siblings == "0")
  
  # Perform the chi-square test only if more than one row is in the table
  if (nrow(contingency_table) > 1) {
    test_result <- chisq.test(contingency_table)
    
    # Append results to the results data frame
    results_white2 <- rbind(results_white2, data.frame(
      RACE = "White",
      Cohort = cohort,
      Chi_Square = test_result$statistic,
      p_value = test_result$p.value
    ))
  }
}

results_white2 <- results_white2 %>%
  mutate(Significance = ifelse(p_value > 0.05, "No", "Yes"))

kable(results_white2, caption="Test Result of Zero Inflation for White Population")

```
The table shows that cohorts 1901-1910, 1911-1920, 1921-1930 have significant change in probability of individuals with zero siblings in white population.

#### b. **Family Size Analysis (Mean)**
We apply t-test and ANOVA to check if there is a significant difference in the mean family size across the year for the same cohort.
```{r}
sum_table_black = merged_data_sib %>% filter(Race == "Black/African American" & n_siblings!=-1)
sum_table_white = merged_data_sib %>% filter(Race == "White"& n_siblings!=-1)
```


```{r, include=FALSE}
# Initialize an empty data frame for storing results
test_result_b2 <- data.frame(
  RACE = character(), 
  Cohort = character(), 
  Statistic = numeric(), 
  p_value = numeric(), 
  stringsAsFactors = FALSE
)
##Test for Black population
cohorts1 <- unique(sum_table_black$Cohort)

# Loop through each cohort and apply ANOVA for Mean and Variance
for (cohort in cohorts1) {
  
  # Filter data for the specific cohort
  cohort_data_b <- sum_table_black[sum_table_black$Cohort == cohort, ]
  
  # Check if there are at least two unique Census_Year values
  if (length(unique(cohort_data_b$Census_Year)) < 2) {
    cat("\nCohort:", cohort, "has only 1 Census Year. Skipping ANOVA.\n")
    next
  }
  
  if (length(unique(cohort_data_b$Census_Year)) == 2) {
    # Perform t-test
    t_test_result <- t.test(n_siblings ~ Census_Year, data = cohort_data_b)
    
    # Store results in test_result_b
    test_result_b2 <- rbind(
      test_result_b2, 
      data.frame(
        RACE = "Black/African American",
        Cohort = cohort,
        Statistic = t_test_result$statistic,
        p_value = t_test_result$p.value
      )
    )
    
  } else {
    # Perform ANOVA for Mean
    anova_mean_result <- aov(n_siblings ~ factor(Census_Year), data = cohort_data_b)
    anova_summary <- summary(anova_mean_result)
    
    # Extract F-statistic and p-value from ANOVA result
    f_statistic <- anova_summary[[1]]["factor(Census_Year)", "F value"]
    p_value <- anova_summary[[1]]["factor(Census_Year)", "Pr(>F)"]
    
    # Store results in test_result_b
    test_result_b2 <- rbind(
      test_result_b2, 
      data.frame(
        RACE = "Black/African American",
        Cohort = cohort,
        Statistic = f_statistic,
        p_value = p_value
      )
    )
  }
}

test_result_b2 <- test_result_b2 %>%
  mutate(Significance = ifelse(p_value > 0.05, "No", "Yes"))

```

```{r}
kable(test_result_b2, caption = "Test Result of Mean Family Size for Black Population")
```
The table shows that mean number of siblings change significantly in cohorts 1901-1910 and 1921-1930 in black population.

```{r, include=FALSE}
test_result_w2 <- data.frame(
  RACE = character(), 
  Cohort = character(), 
  Statistic = numeric(), 
  p_value = numeric(), 
  stringsAsFactors = FALSE
)

##Test for White population
cohorts2 <- unique(sum_table_white$Cohort)

# Loop through each cohort and apply ANOVA for Mean and Variance
for (cohort in cohorts2) {
  
  # Filter data for the specific cohort
  cohort_data_w <- sum_table_white[sum_table_white$Cohort == cohort, ]
  
 # Check if there are at least two unique Census_Year values
  if (length(unique(cohort_data_w$Census_Year)) < 2) {
    cat("\nCohort:", cohort, "has only 1 Census Year. Skipping ANOVA and t-test.\n")
    next
  }
  
  if (length(unique(cohort_data_w$Census_Year)) == 2) {
    # Perform t-test
    t_test_result <- t.test(n_siblings ~ Census_Year, data = cohort_data_w)
    
    # Store results in test_result_w
    test_result_w2 <- rbind(
      test_result_w2, 
      data.frame(
        RACE = "White",
        Cohort = cohort,
        Statistic = t_test_result$statistic,
        p_value = t_test_result$p.value
      )
    )
    
  } else {
    # Perform ANOVA for Mean
    anova_mean_result <- aov(n_siblings ~ factor(Census_Year), data = cohort_data_w)
    anova_summary <- summary(anova_mean_result)
    
    # Extract F-statistic and p-value from ANOVA result
    f_statistic <- anova_summary[[1]]["factor(Census_Year)", "F value"]
    p_value <- anova_summary[[1]]["factor(Census_Year)", "Pr(>F)"]
    
    # Store results in test_result_w
    test_result_w2 <- rbind(
      test_result_w2, 
      data.frame(
        RACE = "White",
        Cohort = cohort,
        Statistic = f_statistic,
        p_value = p_value
      )
    )
  }
}

test_result_w2 <- test_result_w2 %>%
  mutate(Significance = ifelse(p_value > 0.05, "No", "Yes"))

```

```{r}
kable(test_result_w2, caption = "Test Result of Mean Family Size for White Population")
```
The mean number of siblings change significantly in cohorts 1901-1910, 1911-1920, 1921-1930 in white population.

#### c. **Family Size Analysis (Variance)**
We apply Levene's test to check if there is significant difference in the variance of family size across year for the same cohort. 

```{r, include=FALSE}
# Initialize a results dataframe
test_var_b2 <- data.frame(
  RACE = character(), 
  Cohort = character(), 
  Statistic = numeric(), 
  p_value = numeric(), 
  stringsAsFactors = FALSE
)

cohorts1 <- unique(sum_table_black$Cohort)

# Loop through each cohort and apply Levene's Test
for (cohort in cohorts1) {
  
  # Filter data for the specific cohort
  cohort_data_b <- sum_table_black[sum_table_black$Cohort == cohort, ]
  
  # Check if there are at least two unique Census_Year values
  if (length(unique(cohort_data_b$Census_Year)) < 2) {
    cat("\nCohort:", cohort, "has only 1 Census Year. Skipping Levene's Test.\n")
    next
  }
  
  # Perform Levene's Test for variance
  levene_result <- leveneTest(n_siblings ~ factor(Census_Year), data = cohort_data_b)
  
  # Extract F-statistic and p-value
  f_statistic <- levene_result[["F value"]][1]
  p_value <- levene_result[["Pr(>F)"]][1]
  
  # Store results in test_var_b2
  test_var_b2 <- rbind(
    test_var_b2, 
    data.frame(
      RACE = "Black/African American",
      Cohort = cohort,
      Statistic = f_statistic,
      p_value = p_value
    )
  )
}

# Add significance column
test_var_b2 <- test_var_b2 %>%
  mutate(Significance = ifelse(p_value > 0.05, "No", "Yes"))
```

```{r}
kable(test_var_b2, caption="Test Result of Variance of Family Size for Black Population")
```
The table above summarizes the test result for black population. We observe that the variance of family size change significantly across census year in cohort 1901-1910 and 1921-1930.

```{r, include=FALSE}
# Initialize a results dataframe
test_var_w2 <- data.frame(
  RACE = character(), 
  Cohort = character(), 
  Statistic = numeric(), 
  p_value = numeric(), 
  stringsAsFactors = FALSE
)

cohorts2 <- unique(sum_table_white$Cohort)

# Loop through each cohort and apply ANOVA for Mean and Variance
for (cohort in cohorts2) {
  
  # Filter data for the specific cohort
  cohort_data_w <- sum_table_white[sum_table_white$Cohort == cohort, ]
  
  # Check if there are at least two unique Census_Year values
  if (length(unique(cohort_data_w$Census_Year)) < 2) {
    cat("\nCohort:", cohort, "has only 1 Census Year. Skipping Levene's Test.\n")
    next
  }
  
  # Perform Levene's Test for variance
  levene_result <- leveneTest(n_siblings ~ factor(Census_Year), data = cohort_data_w)
  
  # Extract F-statistic and p-value
  f_statistic <- levene_result[["F value"]][1]
  p_value <- levene_result[["Pr(>F)"]][1]
  
  # Store results in test_var_w2
  test_var_w2 <- rbind(
    test_var_w2, 
    data.frame(
      RACE = "Black/African American",
      Cohort = cohort,
      Statistic = f_statistic,
      p_value = p_value
    )
  )
}

# Add significance column
test_var_w2 <- test_var_w2 %>%
  mutate(Significance = ifelse(p_value > 0.05, "No", "Yes"))
```

```{r}
kable(test_var_w2, caption="Test Result of Variance of Family Size for White Population")
```
This table summarizes the test result for white population. We observe that the variance of family size only change significantly across census year in cohort 1901-1910.

#### d. **Model Fit Analysis**
Same as the children's part, we use visualization instead of statistical test here due to the due lack of data variability. The plot shows that the best model for each cohort(those with 1+ corresponding census year) is stable over time.
```{r}
ggplot(best_models_sib, aes(x = Census_Year, y = Cohort, fill = Best_Model)) +
  geom_tile(color = "white", lwd = 0.5, linetype = 1) + # Create the tiles
  facet_wrap(~Race, nrow = 2) + # Facet by Race
  scale_fill_manual(values = c("Poisson" = "#0072B2", "Zero_Inflated_NB" = "#F0E442", "Negative_Binomial" = "grey")) + 
  labs(
    title = "Best Model(siblings) by Race, Census Year, and Cohort(Birth Range)",
    x = "Census Year",
    y = "Birth Range",
    fill = "Best Model"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, hjust = 0.5),
    legend.position = "bottom"
  )
```

